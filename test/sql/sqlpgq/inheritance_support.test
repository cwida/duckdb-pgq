# name: test/sql/sqlpgq/basic_match.test
# group: [sqlpgq]

statement ok
pragma enable_verification

require sqlpgq

statement ok
CREATE TABLE Person(id BIGINT, name VARCHAR);

statement ok
CREATE TABLE Organisation(name VARCHAR, id BIGINT, kind VARCHAR);

statement ok
CREATE TABLE Company(name VARCHAR, id BIGINT, kind VARCHAR);

statement ok
CREATE TABLE University(name VARCHAR, id BIGINT, kind VARCHAR);

statement ok
CREATE TABLE worksAt(personId BIGINT, organisationId BIGINT);

statement ok
INSERT INTO Person VALUES (0, 'Daniel'), (1, 'Tavneet'), (2, 'Gabor'), (3, 'Peter'), (4, 'David');

statement ok
INSERT INTO worksAt VALUES (0,1), (0,2), (0,3), (3,0), (1,2), (1,3), (2,3), (4,3);

statement ok
INSERT INTO University VALUES ('VU', 0, 'University'), ('UVA', 1, 'University');

statement ok
INSERT INTO Company VALUES ('EY', 2, 'Company'), ('CWI', 3, 'Company');

statement ok
INSERT INTO Organisation (SELECT * from university union select * from company);

statement ok
ALTER TABLE Organisation ADD COLUMN subcategory BIGINT;

statement ok
UPDATE organisation set subcategory=case when id in (select id from university) then 2**0 when id in (select id from company) then 2**1 end;

statement ok
CREATE PROPERTY GRAPH pg
VERTEX TABLES (
    Person LABEL Person,
    Organisation LABEL Organisation IN subcategory(university, company)
    )
EDGE TABLES (
    worksAt SOURCE KEY ( personId ) REFERENCES Person ( id )
            DESTINATION KEY ( organisationId ) REFERENCES Organisation ( id )
            LABEL worksAt
    );

query IIII
SELECT *
FROM GRAPH_TABLE(pg
    MATCH (p:Person)-[w:worksAt]->(u:organisation)
    COLUMNS (p.id, p.name, u.id, u.name)
    ) result
----
0	Daniel	1	UVA
0	Daniel	2	EY
0	Daniel	3	CWI
3	Peter	0	VU
1	Tavneet	2	EY
1	Tavneet	3	CWI
2	Gabor	3	CWI
4	David	3	CWI

query IIII
SELECT *
FROM GRAPH_TABLE(pg
    MATCH (p:Person)-[w:worksAt]->(u:ORGANISATION)
    COLUMNS (p.id, p.name, u.id, u.name)
    ) result
----
0	Daniel	1	UVA
0	Daniel	2	EY
0	Daniel	3	CWI
3	Peter	0	VU
1	Tavneet	2	EY
1	Tavneet	3	CWI
2	Gabor	3	CWI
4	David	3	CWI


query IIII
SELECT *
FROM GRAPH_TABLE(pg
    MATCH (p:Person)-[w:worksAt]->(u:university)
    COLUMNS (p.id, p.name, u.id, u.name)
    ) result
----
0	Daniel	1	UVA
3	Peter	0	VU

query IIII
SELECT *
FROM GRAPH_TABLE(pg
    MATCH (p:Person)-[w:worksAt]->(u:company)
    COLUMNS (p.id, p.name, u.id, u.name)
    ) result
----
0	Daniel	3	CWI
1	Tavneet	3	CWI
2	Gabor	3	CWI
4	David	3	CWI
0	Daniel	2	EY
1	Tavneet	2	EY

# Should work with different capitalization
query IIII
SELECT *
FROM GRAPH_TABLE(pg
    MATCH (p:Person)-[w:worksAt]->(u:COMPANY)
    COLUMNS (p.id, p.name, u.id, u.name)
    ) result
----
0	Daniel	3	CWI
1	Tavneet	3	CWI
2	Gabor	3	CWI
4	David	3	CWI
0	Daniel	2	EY
1	Tavneet	2	EY

query IIII
SELECT *
FROM GRAPH_TABLE(pg
    MATCH (p:organisation)<-[w:worksAt]-(u:person)
    COLUMNS (p.id, p.name, u.id, u.name)
    ) result
----
1	UVA	0	Daniel
2	EY	0	Daniel
3	CWI	0	Daniel
0	VU	3	Peter
2	EY	1	Tavneet
3	CWI	1	Tavneet
3	CWI	2	Gabor
3	CWI	4	David

query IIII
SELECT *
FROM GRAPH_TABLE(pg
    MATCH (p:university)<-[w:worksAt]-(u:person)
    COLUMNS (p.id, p.name, u.id, u.name)
    ) result
----
1	UVA	0	Daniel
0	VU	3	Peter